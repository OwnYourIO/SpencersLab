# - IP Based filtering (Traefik?)
# - Middleware for Traefik
# - Maybe external routes/ingress/egress
seaweedfs-csi-driver:
  seaweedfsFiler: "seaweedfs-filer.infra.spencerslab.com:8880,seaweedfs-filer.infra.spencerslab.com:8881,seaweedfs-filer.infra.spencerslab.com:8882,seaweedfs-filer.infra.spencerslab.com:8883,seaweedfs-filer.infra.spencerslab.com:8884"

qbittorrent:
  nameOverride: "qbittorrent"
  controllers:
    main:
      initContainers:
        install-vuetorrent:
          image: busybox:1.36.1@sha256:c3839dd800b9eb7603340509769c43e146a74c63dca3045a8e7dc8ee07e53966
          command:
            - "/bin/sh"
            - -c
          args:
            - |
              # renovate: github-release depName=WDaan/VueTorrent
              VUETORRENT_VERSION="v2.8.0"
              rm -rf /config/vuetorrent
              busybox wget -qO- "https://github.com/WDaan/VueTorrent/releases/download/$${VUETORRENT_VERSION}/vuetorrent.zip" | busybox unzip -d /config -
          volumeMounts:
            - name: config
              mountPath: /config
      containers:
        main:
          image:
            repository: ghcr.io/onedr0p/qbittorrent
            tag: 5.0.0

          env:
            TZ: America/Denver
            QBITTORRENT__PORT: &port 8080
            QBITTORRENT__BT_PORT: &port-bt 58462
            QBT_BitTorrent__Session__Interface: eth0
            QBT_BitTorrent__Session__InterfaceAddress:
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
            QBT_BitTorrent__Session__InterfaceName: eth0
            QBT_Preferences__WebUI__AuthSubnetWhitelistEnabled: true
            QBT_Preferences__WebUI__AuthSubnetWhitelist: |-
              10.42.3.0/24, 10.42.0.0/24, 10.42.2.0/24, 10.42.1.0/24, 192.168.42.0/24, 192.168.1.0/24
          resources:
            requests:
              cpu: 500m
              memory: 1Gi
            limits:
              memory: 8Gi
      pod:
        securityContext:
          runAsUser: 1000
          runAsGroup: 1000
          fsGroup: 1000
          fsGroupChangePolicy: "OnRootMismatch"
          supplementalGroups: [10000]

  service:
    main:
      controller: main
      ports:
        http:
          port: *port
    bittorent:
      enabled: true
      controller: main
      type: LoadBalancer
      ports:
        bittorrent:
          enabled: true
          port: *port-bt
          protocol: TCP
          targetPort: *port-bt
      externalTrafficPolicy: Local

  ingress:
    main:
      enabled: true
      hosts:
        - host: "qbittorrent.spencerslab.com"
          paths:
            - path: /
              pathType: Prefix
              service: 
                identifier: main
                port: http
      tls:
        - secretName: wildcard-cert
          hosts:
            - "qbittorrent.spencerslab.com"

  persistence:
    config:
      enabled: true
      existingClaim: qbittorrent
      advancedMounts:
        main:
          main:
          - path: /config

    media:
      enabled: true
      existingClaim: media
      advancedMounts:
        main:
          main:
          - path: /media
