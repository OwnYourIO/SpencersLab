{{- range $name, $config := .Values.proxy.subdomains }}
# This is mostly used to detect local traffic and force it to use the local middleware rather than remote.
---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: "{{ $name }}-local-ingress"
  namespace: default
spec:
  entryPoints:
    - web
    - websecure
  tls:
    secretName: wildcard-cert
  routes:
    - match: Host(`{{ $name }}.{{ $.Values.domain }}`) && (ClientIP(`10.0.0.0/16`) || ClientIP(`192.168.0.0/16`))
      kind: Rule
      services:
        - name: "{{ $name }}-service"
          port: 443
      middlewares:
      {{- if dig "ingressRoute" "middlewares" false $config }}
      {{- range $config.ingressRoute.middlewares }}
        - name: {{ . }}
      {{- end }}
      {{- else }}
        - name: {{ $.Values.proxy.middlewares.entrypoint }}
        - name: {{ $.Values.proxy.middlewares.allowList }}
      {{- end }}
{{- end }}
