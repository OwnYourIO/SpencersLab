{{- range $name, $config := .Values.proxy.subdomains }}
{{- if or $config.redirect $config.ssoRedirectPath }}
{{- $basePath := coalesce $config.path $config.ssoRedirectPath "/" }}
{{- $pathWithDomain := regexReplaceAll "\\$\\.Values\\.domain" $basePath $.Values.domain }}
{{- $finalPath := regexReplaceAll "\\$\\.Values\\.authRealm" $pathWithDomain $.Values.authRealm }}
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: redirect-{{ $name }}
spec:
  plugin:
    traefik-plugin-redirect-on-status:
      redirectUri: https://{{ $name }}.{{ $.Values.domain }}{{ $finalPath }}
      redirectCode: {{ coalesce $config.redirectCode "307" }}
      status:
        {{- if dig "redirect" "status" false $config }}
        {{- range $config.redirect.status }}
        - {{ . | quote }}
        {{- end }}
        {{- else }}
        - "403"
        {{- end }}
{{- end }}
{{- end }}
