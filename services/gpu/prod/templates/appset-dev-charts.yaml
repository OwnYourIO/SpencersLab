apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: '{{ index .Values "serviceName" }}-charts-appset'
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
    # Generator for apps that should deploy to all cluster.
    - matrix:
        generators:
          - clusters: {}
          - list:
              elements:
                - appName: flowise
                  # version: 1.0.0
                  # repository: https://example.com/helm
                  namespace: default
                  ServerSideApply: "false"
                  {{- if index .Values "flowise" }}
                  values: {{ index .Values "flowise" | toJson }}
                  {{- end }}
                  serviceName: {{ index .Values "serviceName" }}
                - appName: langflow
                  # version: 1.0.0
                  # repository: https://example.com/helm
                  namespace: default
                  ServerSideApply: "false"
                  {{- if index .Values "langflow" }}
                  values: {{ index .Values "langflow" | toJson }}
                  {{- end }}
                  serviceName: {{ index .Values "serviceName" }}
                - appName: n8n
                  # version: 1.0.0
                  # repository: https://example.com/helm
                  namespace: default
                  ServerSideApply: "false"
                  {{- if index .Values "n8n" }}
                  values: {{ index .Values "n8n" | toJson }}
                  {{- end }}
                  serviceName: {{ index .Values "serviceName" }}
                # TODO: Enable these
                #- appName: qdrant
                #  # version: 1.0.0
                #  # repository: https://example.com/helm
                #  namespace: default
                #  ServerSideApply: "false"
                #- appName: neo4j
                #  # version: 1.0.0
                #  # repository: https://example.com/helm
                #  namespace: default
                #  ServerSideApply: "false"
                #- appName: langfuse
                #  # version: 1.0.0
                #  # repository: https://example.com/helm
                #  namespace: default
                #  ServerSideApply: "false"
                #- appName: searxng
                #  # version: 1.0.0
                #  # repository: https://example.com/helm
                #  namespace: default
                #  ServerSideApply: "false"
                - appName: supabase
                  # version: 1.0.0
                  # repository: https://example.com/helm
                  namespace: default
                  ServerSideApply: "false"
                  {{- if index .Values "supabase" }}
                  values: {{ index .Values "supabase" | toJson }}
                  {{- end }}
                  serviceName: {{ index .Values "serviceName" }}
                - appName: archon
                  # version: 1.0.0
                  # repository: https://example.com/helm
                  namespace: default
                  ServerSideApply: "false"
                  {{- if index .Values "archon" }}
                  values: {{ index .Values "archon" | toJson }}
                  {{- end }}
                  serviceName: {{ index .Values "serviceName" }}
                # Helm repository charts (external charts)
                - appName: seaweedfs-csi-driver
                  version: 0.2.3
                  repository: https://seaweedfs.github.io/seaweedfs-csi-driver/helm
                  namespace: default
                  ServerSideApply: "true"
                  {{- if index .Values "seaweedfs-csi-driver" }}
                  values: {{ index .Values "seaweedfs-csi-driver" | toJson }}
                  {{- end }}
                  serviceName: {{ index .Values "serviceName" }}
                - appName: cloudnative-pg
                  version: 0.25.0
                  repository: https://cloudnative-pg.github.io/charts
                  namespace: default
                  ServerSideApply: "true"
                  serviceName: {{ index .Values "serviceName" }}
                - appName: ollama
                  version: 1.26.0
                  repository: https://helm.otwld.com/
                  namespace: default
                  ServerSideApply: "false"
                  {{- if index .Values "ollama" }}
                  values: {{ index .Values "ollama" | toJson }}
                  {{- end }}
                  serviceName: {{ index .Values "serviceName" }}
                - appName: open-webui
                  version: 7.2.0
                  repository: https://helm.openwebui.com/
                  namespace: default
                  ServerSideApply: "false"
                  {{- if index .Values "open-webui" }}
                  values: {{ index .Values "open-webui" | toJson }}
                  {{- end }}
                  serviceName: {{ index .Values "serviceName" }}
                - appName: amd-gpu
                  version: 0.20.0
                  repository: https://rocm.github.io/k8s-device-plugin/
                  namespace: default
                  ServerSideApply: "true"
                  serviceName: {{ index .Values "serviceName" }}
                - appName: coder
                  version: 2.25.1
                  repository: https://helm.coder.com/v2
                  namespace: default
                  ServerSideApply: "false"
                  {{- if index .Values "coder" }}
                  values: {{ index .Values "coder" | toJson }}
                  {{- end }}
                  serviceName: {{ index .Values "serviceName" }}
  template:
    metadata:
      name: "{{ `{{ .serviceName }}` }}-{{ `{{ .appName }}` }}"
      annotations:
        argocd.argoproj.io/manifest-generate-paths: ".;.."
    spec:
      project: default
      destination:
        name: "{{ `{{ .name }}` }}"
        namespace: "{{ `{{.namespace }}` }}"
  templatePatch: |
    {{ `{{- $valuesKey := .appName }}` }}
    {{ `{{- if hasKey . "alias" }}` }}
      {{ `{{- $valuesKey = .alias }}` }}
    {{ `{{- end }}` }}
    # Dynamic source configuration - toggle specific fields based on chart type
    spec:
      sources:
        - repoURL: '{{ `{{ index .metadata.annotations "services.repo" }}` }}'
          targetRevision: main
          ref: services
        - repoURL: '{{ `{{ index .metadata.annotations "values.repo" }}` }}'
          targetRevision: main
          ref: values
        - repoURL: '{{ `{{ if hasKey . "repository" }}{{ .repository }}{{ else }}{{ index .metadata.annotations "services.repo" }}{{ end }}` }}'
          targetRevision: "{{ `{{ dig "version" "main" . }}` }}"
          {{ `{{- if hasKey . "version" }}` }}
          chart: "{{ `{{ .appName }}` }}"
          {{ `{{- else }}` }}
          path: "charts/{{ `{{ .appName }}` }}"
          {{ `{{- end }}` }}
          helm:
            parameters:
              - name: domain
                value: '{{ `{{ index .metadata.annotations "domain" }}` }}'
              - name: clusterName
                value: '{{ `{{ index .metadata.annotations "clusterName" }}` }}'
            valueFiles:
              # Per-app custom values URL (overrides service-wide for specific app):
              # Example: metadata.annotations.services.gpu.zigbee2mqtt.customValuesUrl
              {{ `{{- $appCustomValuesUrl := index .metadata.annotations (printf "services.%s.%s.customValuesUrl" .serviceName .appName) }}` }}
              {{ `{{- if $appCustomValuesUrl }}` }}
              - {{ `{{ $appCustomValuesUrl }}` }}
              {{ `{{- end }}` }}
            {{ `{{- $serviceCustomValues := index .metadata.annotations (printf "services.%s.customValues" .serviceName) | default "{}" | fromJson }}` }}
            {{ `{{- $appCustomValues := index .metadata.annotations (printf "services.%s.%s.customValues" .serviceName .appName) | default "{}" | fromJson }}` }}
            {{ `{{- $baseValues := dict }}` }}
            {{ `{{- if hasKey . "values" }}` }}
              {{ `{{- $baseValues = .values }}` }}
            {{ `{{- end }}` }}
            {{ `{{- $mergedValues := merge (deepCopy $appCustomValues) (deepCopy $serviceCustomValues) (deepCopy $baseValues) }}` }}
            {{ `{{- if or (hasKey . "values") (ne (len $serviceCustomValues) 0) (ne (len $appCustomValues) 0) }}` }}
            valuesObject: {{ `{{ $mergedValues | toYaml | nindent 14 }}` }}
            {{ `{{- end }}` }}
      syncPolicy:
        {{ `{{- $serviceSelfHeal := index .metadata.annotations (printf "services.%s.selfHeal" .serviceName) | default "true" }}` }}
        {{ `{{- $appSelfHeal := index .metadata.annotations (printf "services.%s.%s.selfHeal" .serviceName .appName) | default $serviceSelfHeal }}` }}
        {{ `{{- if eq $appSelfHeal "true" }}` }}
        automated:
          prune: true
          selfHeal: true
        {{ `{{- end }}` }}
        syncOptions:
          - CreateNamespace=true
          # Needed for: https://github.com/prometheus-community/helm-charts/issues/3345
          - ServerSideApply={{ `{{ .ServerSideApply }}` }}
