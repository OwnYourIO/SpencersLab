bitwardenIds:
  crowdsec-secret: 9e144cd6-5e85-4ded-b913-b228003c68a0
traefik:
  additionalArguments:
    - "--api"
    - "--api.dashboard=true"
    - "--api.insecure=true"
    - "--log.level=DEBUG"
    - "--serversTransport.insecureSkipVerify=true"
    - "--log.format=json"
    - "--accesslog.format=json"
  dashboard: 
    enabled: true
  providers:
    kubernetesCRD:
      allowCrossNamespace: true
      allowExternalNameServices: true
    kubernetesIngress:
      allowEmptyServices: true
      allowExternalNameServices: true
  experimental:
    plugins:
      geoblock:
        moduleName: "github.com/PascalMinder/geoblock"
        version: "v0.2.8"
      traefik-oidc-relying-party:
        moduleName: "github.com/alexdelprete/traefik-oidc-relying-party"
        version: "v1.0.0-alpha.1"
      crowdsec-bouncer-traefik-plugin:
        moduleName: github.com/maxlerebourg/crowdsec-bouncer-traefik-plugin
        version: "v1.3.5" 
  volumes:
    - name: crowdsec-lapi-secrets
      type: secret
      mountPath: /run/secrets/lapi
      subpath: csLapiSecret
      readOnly: true

  # From https://github.com/traefik/traefik-helm-chart/blob/master/traefik/values.yaml#L331C1-L334C17
  #volumes: 
  #  - name: client_id
  #    mountPath: "/run/secrets/client_id"
  #    type: secret
  #    key: # TODO: 
  #  - name: client_secret
  #    mountPath: "/run/secrets/client_secret"
  #    type: secret
  #    key: # TODO:

  logs:
    general:
      level: DEBUG
      format: json
    access:
      enabled: true

crowdsec:
  tls:
    enabled: true
    crowdsec-bouncer-traefik-plugin:
      reflector:
        namespaces: ["kube-system"]
  lapi:
    env:
      - name: TZ
        value: America/Denver
      - name: ENROLL_INSTANCE_NAME
        value: remote-proxy
      # Setting the enroll key after initial startup requires force enrollment which currently breaks the local API.
      - name: ENROLL_KEY
        valueFrom:
          secretKeyRef:
            name: crowdsec-keys
            key: ENROLL_KEY
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
    persistentVolume:
      # -- Persistent volume for data folder. Stores e.g. registered bouncer api keys
      data:
        enabled: true
        accessModes:
          - ReadWriteOnce
        size: 1Gi
      # -- Persistent volume for config folder. Stores e.g. online api credentials
      config:
        enabled: true
        accessModes:
          - ReadWriteOnce
        size: 100Mi
  agent:
    acquisition:
      config:
        - filenames:
            - /var/log/containers/traefik-[0-9]*_kube-system_*.log
          labels:
            type: traefik
            program: traefik
          force_inotify: true
          poll_without_inotify: true
    env:
      - name: TZ
        value: America/Denver
      - name: COLLECTIONS
        value: >-
          crowdsecurity/linux
          crowdsecurity/traefik
          crowdsecurity/base-http-scenarios
          crowdsecurity/http-cve
      
    persistentVolume:
      # -- Persistent volume for config folder. Stores local config (parsers, scenarios etc.)
      config:
        enabled: true
        accessModes:
          - ReadWriteOnce
        size: 100Mi 
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
