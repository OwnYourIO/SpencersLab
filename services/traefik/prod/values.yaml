keycloak:
  realm: SpencersLab

middleware:
  crowdsec: 
    enabled: false
  oidc-keycloak:
    enabled: false
  geoblock:
    enabled: false
  
domain: OVERRIDE_VIA_APPSET

bitwardenIds:
  crowdsec-secret: 9e144cd6-5e85-4ded-b913-b228003c68a0
  traefik-sso-secret: fa9bb676-c5a9-431e-903f-b22b0038bf5c

cert-manager:
  installCRDs: true

traefik:
  additionalArguments:
    - "--api"
    - "--api.dashboard=true"
    - "--api.insecure=true"
    - "--serversTransport.insecureSkipVerify=true"
  dashboard: 
    enabled: true
  providers:
    kubernetesCRD:
      allowCrossNamespace: true
      allowExternalNameServices: true
    kubernetesIngress:
      allowEmptyServices: true
      allowExternalNameServices: true

  experimental:
    plugins:
      geoblock:
        moduleName: "github.com/PascalMinder/geoblock"
        # renovate: depName=github.com/PascalMinder/geoblock
        version: "v0.2.8"
      keycloakopenid:
        moduleName: "github.com/jmcarbo/keycloakopenid"
        # renovate: depName=github.com/jmcarbo/keycloakopenid
        version: "v0.1.40"
      crowdsec:
        moduleName: github.com/maxlerebourg/crowdsec-bouncer-traefik-plugin
        # renovate: depName=github.com/maxlerebourg/crowdsec-bouncer-traefik-plugin
        version: "v1.3.5"

  service:
    externalTrafficPolicy: Local
  ingressRoute:
    dashboard:
      enabled: false
      matchRule: PathPrefix(`/dashboard`) || PathPrefix(`/api`)
      # -- The internal service used for the dashboard ingressRoute
      services:
        - name: api@internal
          kind: TraefikService
      # -- Specify the allowed entrypoints to use for the dashboard ingress route, (e.g. traefik, web, websecure).
      # By default, it's using traefik entrypoint, which is not exposed.
      # /!\ Do not expose your dashboard without any protection over the internet /!\
      entryPoints: ["traefik", "websecure"]
      # -- Additional ingressRoute middlewares (e.g. for authentication)
      middlewares: []
      # -- TLS options (e.g. secret containing certificate)
      tls:
        hosts:
          - traefik.monitoring.spencerslab.com
        secretName: cluster-wildcard-cert

  metrics:
    prometheus:
      serviceMonitor:
        enabled: true
        namespace: default
        additionalLabels:
          release: monitoring-agent
          prometheus: system-monitoring-prometheus-prometheus

  # To create this secret:
  # kubectl create secret generic crowdsec-bouncer-key -n kube-system --from-literal="api_key=<THE_GENERATED_BOUNCER_API_KEY"
  
  logs:
    #general:
    #  level: DEBUG
    access:
      enabled: true

crowdsec:
  container_runtime: containerd
  tls:
    enabled: true
  lapi:
    env:
      - name: TZ
        value: America/Denver
      - name: ENROLL_INSTANCE_NAME
        value: remote-proxy
      # Setting the enroll key after initial startup requires force enrollment which currently breaks the local API.
      - name: ENROLL_KEY
        valueFrom:
          secretKeyRef:
            name: crowdsec-keys
            key: ENROLL_KEY
      - name: LEVEL_DEBUG
        value: "true"
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
        additionalLabels:
          release: monitoring-agent
    persistentVolume:
      # -- Persistent volume for data folder. Stores e.g. registered bouncer api keys
      data:
        enabled: true
        accessModes:
          - ReadWriteOnce
        size: 1Gi
      # -- Persistent volume for config folder. Stores e.g. online api credentials
      config:
        enabled: true
        accessModes:
          - ReadWriteOnce
        size: 100Mi
  agent:
    acquisition:
      - namespace: kube-system
        podName: traefik-[0-9]*
        program: traefik
        poll_without_inotify: true
    env:
      - name: TZ
        value: America/Denver
      - name: COLLECTIONS
        value: >-
          crowdsecurity/linux
          crowdsecurity/traefik
          crowdsecurity/base-http-scenarios
          crowdsecurity/http-cve

    persistentVolume:
      # -- Persistent volume for config folder. Stores local config (parsers, scenarios etc.)
      config:
        enabled: true
        accessModes:
          - ReadWriteOnce
        size: 100Mi 
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
        additionalLabels:
          release: monitoring-agent
