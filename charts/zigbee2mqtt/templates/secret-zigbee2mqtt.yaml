{{ if (index .Values "bitwardenIds") }}
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ .Release.Name }}
spec:
  refreshInterval: 1h
  target:
    name: "{{ .Release.Name }}-secret"
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        ZIGBEE2MQTT_CONFIG_FRONTEND_URL: "https://{{ .Values.appName }}.{{ .Values.domain }}"
        ZIGBEE2MQTT_ONBOARD_URL: "https://{{ .Values.appName }}.{{ .Values.domain }}"
        ZIGBEE2MQTT_CONFIG_SERIAL_PORT: "tcp://{{ .Release.Name }}.{{ .Values.domain }}:6638"
        ZIGBEE2MQTT_CONFIG_MQTT_SERVER: "{{ `{{ .mqtt_server_url }}` }}"
        ZIGBEE2MQTT_CONFIG_MQTT_USER: "{{ `{{ .mqtt_username }}` }}"
        ZIGBEE2MQTT_CONFIG_MQTT_PASSWORD: "{{ `{{ .mqtt_password }}` }}"
  data:
    - secretKey: mqtt_server_url
      sourceRef:
        storeRef:
          name: bitwarden-uri
          kind: SecretStore
      remoteRef:
        key: {{ index .Values "bitwardenIds" "zigbee2mqtt" }}
        conversionStrategy: Default
        decodingStrategy: None
        metadataPolicy: None
    - secretKey: mqtt_username
      sourceRef:
        storeRef:
          name: bitwarden-login
          kind: SecretStore
      remoteRef:
        key: {{ index .Values "bitwardenIds" "zigbee2mqtt" }}
        property: username
        conversionStrategy: Default
        decodingStrategy: None
        metadataPolicy: None
    - secretKey: mqtt_password
      sourceRef:
        storeRef:
          name: bitwarden-login
          kind: SecretStore
      remoteRef:
        key: {{ index .Values "bitwardenIds" "zigbee2mqtt" }}
        property: password
        conversionStrategy: Default
        decodingStrategy: None
        metadataPolicy: None
...
{{ end }}
---
