apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: "{{ .Release.Name }}"
spec:
  refreshInterval: 1h
  target:
    name: "{{ .Release.Name }}"
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        # Database connection
        DATABASE_URL: "postgresql://{{ `{{ .db_username }}` }}:{{ `{{ .db_password }}` }}@pg-rallly-rw:5432/rallly"
        
        # Application secrets
        SECRET_PASSWORD: "{{ `{{ .secret_password }}` }}"
        INITIAL_ADMIN_EMAIL: "{{ `{{ .admin_email }}` }}"
        
        # Base URL (constructed from domain)
        NEXT_PUBLIC_BASE_URL: "https://rallly.{{ .Values.domain }}"
        
        # Email configuration
        #SUPPORT_EMAIL: 
        #ALLOWED_EMAILS: 
        #EMAIL_LOGIN_ENABLED: 
        
        # SMTP configuration
        #SMTP_HOST: 
        #SMTP_PORT: 
        #SMTP_SECURE: 
        #SMTP_USER: 
        #SMTP_PWD: 
        
        # OIDC/SSO configuration (optional)
        OIDC_NAME: "SSO"
        OIDC_DISCOVERY_URL: "{{ `{{ .oidc_discovery_url }}` }}"
        OIDC_CLIENT_ID: "{{ `{{ .oidc_client_id }}` }}"
        OIDC_CLIENT_SECRET: "{{ `{{ .oidc_client_secret }}` }}"
        
  data:
    # Database credentials
    - secretKey: db_username
      sourceRef:
        storeRef:
          name: bitwarden-login
          kind: SecretStore
      remoteRef:
        key: '{{ index .Values "bitwardenIds" "rallly-db" }}'
        property: username
        conversionStrategy: Default
        decodingStrategy: None
        metadataPolicy: None
    
    - secretKey: db_password
      sourceRef:
        storeRef:
          name: bitwarden-login
          kind: SecretStore
      remoteRef:
        key: '{{ index .Values "bitwardenIds" "rallly-db" }}'
        property: password
        conversionStrategy: Default
        decodingStrategy: None
        metadataPolicy: None
    
    # Application secrets
    - secretKey: secret_password
      sourceRef:
        storeRef:
          name: bitwarden-login
          kind: SecretStore
      remoteRef:
        key: '{{ index .Values "bitwardenIds" "rallly" }}'
        property: password
        conversionStrategy: Default
        decodingStrategy: None
        metadataPolicy: None
    
    - secretKey: admin_email
      sourceRef:
        storeRef:
          name: bitwarden-login
          kind: SecretStore
      remoteRef:
        key: '{{ index .Values "bitwardenIds" "rallly" }}'
        property: username
        conversionStrategy: Default
        decodingStrategy: None
        metadataPolicy: None
    
    - secretKey: support_email
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: SecretStore
      remoteRef:
        key: '{{ index .Values "bitwardenIds" "rallly" }}'
        property: support_email
        conversionStrategy: Default
        decodingStrategy: None
        metadataPolicy: None
    
    - secretKey: allowed_emails
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: SecretStore
      remoteRef:
        key: '{{ index .Values "bitwardenIds" "rallly" }}'
        property: allowed_emails
        conversionStrategy: Default
        decodingStrategy: None
        metadataPolicy: None
    
    - secretKey: email_login_enabled
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: SecretStore
      remoteRef:
        key: '{{ index .Values "bitwardenIds" "rallly" }}'
        property: email_login_enabled
        conversionStrategy: Default
        decodingStrategy: None
        metadataPolicy: None
    
    # SMTP credentials
    - secretKey: smtp_host
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: SecretStore
      remoteRef:
        key: '{{ index .Values "bitwardenIds" "rallly" }}'
        property: smtp_host
        conversionStrategy: Default
        decodingStrategy: None
        metadataPolicy: None
    
    - secretKey: smtp_port
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: SecretStore
      remoteRef:
        key: '{{ index .Values "bitwardenIds" "rallly" }}'
        property: smtp_port
        conversionStrategy: Default
        decodingStrategy: None
        metadataPolicy: None
    
    - secretKey: smtp_secure
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: SecretStore
      remoteRef:
        key: '{{ index .Values "bitwardenIds" "rallly" }}'
        property: smtp_secure
        conversionStrategy: Default
        decodingStrategy: None
        metadataPolicy: None
    
    - secretKey: smtp_user
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: SecretStore
      remoteRef:
        key: '{{ index .Values "bitwardenIds" "rallly" }}'
        property: smtp_user
        conversionStrategy: Default
        decodingStrategy: None
        metadataPolicy: None
    
    - secretKey: smtp_password
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: SecretStore
      remoteRef:
        key: '{{ index .Values "bitwardenIds" "rallly" }}'
        property: smtp_password
        conversionStrategy: Default
        decodingStrategy: None
        metadataPolicy: None
    
    # OIDC/SSO credentials (optional)
    - secretKey: oidc_discovery_url
      sourceRef:
        storeRef:
          name: bitwarden-uri
          kind: SecretStore
      remoteRef:
        key: '{{ index .Values "bitwardenIds" "rallly-sso" }}'
        conversionStrategy: Default
        decodingStrategy: None
        metadataPolicy: None
    
    - secretKey: oidc_client_id
      sourceRef:
        storeRef:
          name: bitwarden-login
          kind: SecretStore
      remoteRef:
        key: '{{ index .Values "bitwardenIds" "rallly-sso" }}'
        property: username
        conversionStrategy: Default
        decodingStrategy: None
        metadataPolicy: None
    
    - secretKey: oidc_client_secret
      sourceRef:
        storeRef:
          name: bitwarden-login
          kind: SecretStore
      remoteRef:
        key: '{{ index .Values "bitwardenIds" "rallly-sso" }}'
        property: password
        conversionStrategy: Default
        decodingStrategy: None
        metadataPolicy: None
