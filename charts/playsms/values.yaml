bitwardenIds:
  playsms: OVERRIDE_VIA_CUSTOM_VALUES
  playsms-db: OVERRIDE_VIA_CUSTOM_VALUES

domain: OVERRIDE_VIA_APPSET

app-template:
  global:
    nameOverride: &chartName playsms

  controllers:
    playsms:
      annotations:
        reloader.stakater.com/auto: "true"
      initContainers:
        install-composer:
          image:
            repository: playsms/playsms
            tag: 1.4.x
          command:
            - /bin/sh
            - -c
          args:
            - |
              # Install Composer to a location accessible without sudo
              cd /tmp
              curl -sS https://getcomposer.org/download/latest-stable/composer.phar -o composer.phar
              chmod +x composer.phar

              # Move to user's local bin (no sudo needed)
              mkdir -p /home/playsms/bin
              mv composer.phar /home/playsms/bin/composer

              # Add to PATH for current session
              export PATH="/home/playsms/bin:$PATH"

              # Verify it works
              composer --version

              # Make PATH permanent by adding to .bashrc or .profile
              echo 'export PATH="/home/playsms/bin:$PATH"' >> /home/playsms/.bashrc
      containers:
        playsms:
          image:
            repository: playsms/playsms
            tag: 1.4.x
          env:
            TZ: Etc/UTC
            PLAYSMS_VERSION: "1.4.x"
            PLAYSMS_DB_HOST: "localhost"
            PLAYSMS_DB_PORT: "3306"
            PLAYSMS_DB_NAME: "playsms"
            GID: "1000"
            UID: "1000"
          envFrom:
            - secretRef:
                name: "{{ .Release.Name }}"
            - secretRef:
                name: "{{ .Release.Name }}-db"
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              memory: 1Gi
          #securityContext:
          #  allowPrivilegeEscalation: false
          #  capabilities:
          #    drop:
          #      - ALL
        
        mariadb:
          image:
            repository: mariadb
            tag: lts
          env:
            TZ: Etc/UTC
            MARIADB_RANDOM_ROOT_PASSWORD: "1"
            MARIADB_DATABASE: "playsms"
          envFrom:
            - secretRef:
                name: "{{ .Release.Name }}-db"
          resources:
            requests:
              cpu: 100m
              memory: 512Mi
            limits:
              memory: 2Gi
          #securityContext:
          #  allowPrivilegeEscalation: false
          #  capabilities:
          #    drop:
          #      - ALL
        
  service:
    playsms:
      controller: *chartName
      ports:
        http:
          port: 80

  persistence:
    mysql-data:
      existingClaim: playsms-mysql
      globalMounts:
        - path: /var/lib/mysql
          subPath: mysql-data
    playsms:
      existingClaim: playsms-data
      globalMounts:
        - path: /home/playsms/log
          subPath: log
        - path: /home/playsms/web
          subPath: web
        - path: /var/www/html
          subPath: web
