global:
  nameOverride: 389ds

bitwardenIds:
  389ds: OVERRIDE_NEEDED

app-template:
  controllers:
    389ds:
      annotations:
        reloader.stakater.com/auto: "true"
      containers:
        main:
          image:
            repository: 389ds/dirsrv
            tag: 3.1
          env:
            DS_DM_PASSWORD: 
              secretKeyRef:
                name: 389ds-secret
                key: admin-password
            DS_SUFFIX_NAME: dc=spencerslab,dc=com

          probes:
            liveness:
              enabled: true
            readiness:
              enabled: true
          resources:
            requests:
              cpu: 10m
            limits:
              memory: 512Mi

  service:
    389ds:
      controller: 389ds
      ports:
        ldap:
          protocol: TCP
          port: 389
          targetPort: 3389
        ldaps:
          port: 3636

  configMaps:
    ldifs:
      # TO initalize these, need to manually run something like:
      #  dsconf slapd-localhost backend create --suffix "dc=spencerslab,dc=com" --be-name userRoot
      #  ldapadd -x -D "cn=Directory Manager" -W -f /tmp/add_suffix.ldif -H ldap://localhost:3389
      data: 
        00-root.ldif: |-
          # Root creation
          dn: dc=spencerslab,dc=com
          objectClass: top
          objectClass: domain
          dc: SpencersLab

        01-people-ou.ldif: |
          dn: ou=People,dc=spencerslab,dc=com
          objectClass: organizationalUnit
          ou: People
        02-groups-ou.ldif: |
          dn: ou=Groups,dc=spencerslab,dc=com
          objectClass: organizationalUnit
          ou: Groups

        # TODO: I think there is something wrong with these. Running
        # dsidm localhost group list
        # after creating these doesn't return anything.
        11-guest-group.ldif: |-
          dn: cn=Guests,ou=Groups,dc=spencerslab,dc=com
          changetype: add
          objectClass: top
          objectClass: posixGroup
          objectClass: groupOfUniqueNames
          gidNumber: 12345
          cn: Guests
        12-user-group.ldif: |-
          dn: cn=Users,ou=Groups,dc=spencerslab,dc=com
          changetype: add
          objectClass: top
          objectClass: posixGroup
          objectClass: groupOfUniqueNames
          gidNumber: 12346
          cn: Users
        13-power-user-group.ldif: |-
          dn: cn=PowerUsers,ou=Groups,dc=spencerslab,dc=com
          changetype: add
          objectClass: top
          objectClass: posixGroup
          objectClass: groupOfUniqueNames
          gidNumber: 12347
          cn: PowerUsers
        14-admin-group.ldif: |-
          dn: cn=Admins,ou=Groups,dc=spencerslab,dc=com
          changetype: add
          objectClass: top
          objectClass: posixGroup
          objectClass: groupOfUniqueNames
          gidNumber: 12348
          cn: Admins

  persistence:
    data:
      existingClaim: 389ds-data
    ldifs:
      type: configMap
      name: '{{ .Release.Name }}'
      globalMounts:
        - path: /data/ldif/
