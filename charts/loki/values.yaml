deploymentMode: SimpleScalable

loki:
  auth_enabled: false

  schemaConfig:
    configs:
      - from: "2024-04-01"
        store: tsdb                    # TSDB required for Loki 2.8+
        object_store: s3
        schema: v13
        index:
          prefix: loki_index_
          # I think 24 hours is required?
          period: 24h                  # Required for retention to work

  storage:
    type: s3
    bucketNames:
      chunks: "logs"
      ruler: "spencerslab"
    s3:
      endpoint: s3.spencerslab.com
      region: us-co-1

  storage_config:
    tsdb_shipper:
      active_index_directory: /loki/index
      cache_location: /loki/index_cache
      cache_ttl: 168h                  # 7 days - keep week's indexes locally

  limits_config:
    retention_period: 2160h            # 90 days global retention
    max_query_lookback: 2160h
    allow_structured_metadata: true
    volume_enabled: true
    retention_stream:
      - selector: '{namespace="dev"}'
        priority: 1
        period: 168h                   # 7 days for dev logs
      - selector: '{namespace="prod"}'
        priority: 2
        period: 4320h                  # 180 days for prod

  compactor:
    working_directory: /data/retention
    compaction_interval: 10m
    retention_enabled: true
    retention_delete_delay: 2h
    retention_delete_worker_count: 150
    delete_request_store: s3

  ingester:
    chunk_encoding: snappy

# IRSA for AWS - most secure credential method
serviceAccount:
  create: true

# Component replicas
backend:
  replicas: 1
  persistence:
    size: 20Gi

read:
  replicas: 2
write:
  replicas: 3
  persistence:
    size: 20Gi

# Enable caching for fast recent queries
chunksCache:
  enabled: true
  allocatedMemory: 4096              # 4GB for chunk cache
resultsCache:
  enabled: true
  allocatedMemory: 1024

# Disable bundled MinIO
minio:
  enabled: false

gateway:
  service:
    type: ClusterIP