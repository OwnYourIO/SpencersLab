deploymentMode: SimpleScalable


loki:
  loki:
    auth_enabled: false
    commonConfig:
      replication_factor: 1
    storage:
      type: s3
      bucketNames:
        chunks: logs
        ruler: logs
        admin: logs
    schemaConfig:
      configs:
        - from: "2026-01-01"
          store: tsdb                    # TSDB required for Loki 2.8+
          object_store: s3
          schema: v13
          index:
            prefix: loki_index_
            # I think 24 hours is required?
            period: 24h                  # Required for retention to work

    storage_config:
      tsdb_shipper:
        active_index_directory: /var/loki/index
        cache_location: /var/loki/index_cache
        cache_ttl: 168h                  # 7 days - keep week's indexes locally
      aws:
        endpoint: https://s3.spencerslab.com
        region: us-co-1
        s3forcepathstyle: true

    limits_config:
      retention_period: 720h # 30 days # 2160h # 90 days global retention
      max_query_lookback: 2160h
      allow_structured_metadata: true
      volume_enabled: true
      retention_stream:
        - selector: '{namespace="dev"}'
          priority: 1
          period: 168h                   # 7 days for dev logs
        - selector: '{namespace="prod"}'
          priority: 2
          period: 4320h                  # 180 days for prod

    compactor:
      working_directory: /var/loki/retention
      compaction_interval: 10m
      retention_enabled: true
      retention_delete_delay: 2h
      retention_delete_worker_count: 150
      delete_request_store: s3

  ingester:
    chunk_encoding: snappy
    wal:
      enabled: true
      dir: /var/loki/wal
      flush_on_shutdown: true      # Ensures data is written before shutdown
      replay_memory_ceiling: 4GB   # Optional: limits memory during WAL replay

    chunk_idle_period: 2h          # How long before idle chunks are flushed
    chunk_retain_period: 30s       # Keep chunks in memory for 30s after flushing
    max_chunk_age: 2h              # Maximum age before forcing flush

  # Component replicas
  backend:
    replicas: 1
    persistence:
      size: 20Gi
    extraEnv:
      - name: AWS_ACCESS_KEY_ID
        valueFrom:
          secretKeyRef:
            name: loki-s3-secret
            key: access_key_id
      - name: AWS_SECRET_ACCESS_KEY
        valueFrom:
          secretKeyRef:
            name: loki-s3-secret
            key: secret_access_key

  read:
    replicas: 1
    extraEnv:
      - name: AWS_ACCESS_KEY_ID
        valueFrom:
          secretKeyRef:
            name: loki-s3-secret
            key: access_key_id
      - name: AWS_SECRET_ACCESS_KEY
        valueFrom:
          secretKeyRef:
            name: loki-s3-secret
            key: secret_access_key
  write:
    replicas: 1
    persistence:
      size: 20Gi
    extraEnv:
      - name: AWS_ACCESS_KEY_ID
        valueFrom:
          secretKeyRef:
            name: loki-s3-secret
            key: access_key_id
      - name: AWS_SECRET_ACCESS_KEY
        valueFrom:
          secretKeyRef:
            name: loki-s3-secret
            key: secret_access_key

  # Enable caching for fast recent queries
  chunksCache:
    enabled: true
    allocatedMemory: 4096              # 4GB for chunk cache
  resultsCache:
    enabled: true
    allocatedMemory: 1024

  # Disable bundled MinIO
  minio:
    enabled: false

  gateway:
    service:
      type: ClusterIP